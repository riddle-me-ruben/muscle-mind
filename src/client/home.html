<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="/static/home.css">
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/x-icon">
</head>
<body>
    <div class="container">
        <h1>Welcome to Muscle Mind!</h1>
        
        <!-- Audio player for background music with autoplay -->
        <audio id="background-music" autoplay loop>
            <source src="{{ url_for('static', filename='media/lobby.mp3') }}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>

        <!-- Volume control with icon -->
        <div class="audio-control">
            <img
                id="audio-icon"
                src="{{ url_for('static', filename='audio-on.png') }}"
                alt="Audio Control"
                class="audio-icon"
                onclick="toggleMute()"
            />
            <input
                type="range"
                id="volume-slider"
                min="0"
                max="1"
                step="0.01"
                value="1"
                oninput="adjustVolume()"
            />
        </div>
        
        <div class="view-user-form">
            <!-- Form to view quizzes for another user -->
            <form action="{{ url_for('view_other_user_quizzes') }}" method="POST" class="view-quizzes-form">
                <label for="other_user_email" class="form-label">Enter email to view another user's quizzes:</label>
                <input type="email" name="other_user_email" id="other_user_email" class="form-input" placeholder="Enter email..." required>
                <div class="button-group">
                    <button type="submit" class="view-user-button">View Quizzes</button>
                </div>
            </form>

            <!-- Separate form for restoring own quizzes -->
            <form action="{{ url_for('restore_user_quizzes') }}" method="POST" class="restore-form">
                <div class="button-group">
                    <button type="submit" class="restore-user-button">Restore My Quizzes</button>
                </div>
            </form>
        </div>

        <!-- User Analytics Section -->
        {% if analytics %}
        <div class="analytics-section">
            <h2>Your Analytics</h2>
            <p><strong>Quizzes Taken:</strong> {{ analytics.quizzes_taken }}</p>
            <p><strong>Total Questions Answered:</strong> {{ analytics.questions_answered }}</p>
            <p><strong>Average Score:</strong> {{ analytics.avg_score }} %</p>
        </div>
        {% endif %}
        
        <!-- Create Quiz Button -->
        <a href="{{ url_for('create_quiz_route') }}">
            <button class="create-quiz-button">Create Quiz</button>
        </a>

        <!-- Conditional Heading for Quizzes -->
        {% if quizzes and quizzes|length > 0 %}
            {% if session.get('other_user_email') %}
                <h2>Quizzes {{ session.get('other_user_email') }} has created:</h2>
            {% else %}
                <h2>Your Quizzes:</h2>
            {% endif %}
            <ul>
                {% for quiz in quizzes %}
                <li class="quiz-item">
                    <span class="quiz-title">{{ quiz.title }}</span>
                    <div class="button-group">
                        <a href="{{ url_for('quiz_detail_route', quiz_id=quiz['quiz_id'], audio_file=quiz['audio_file']) }}" class="view-quiz-button">View</a>
                        <a href="{{ url_for('take_quiz_route', quiz_id=quiz['quiz_id'], question_num=0) }}" class="take-quiz-button">Take</a>
                        
                        {% if not session.get('other_user_email') %}
                            <!-- Show delete button only for own quizzes -->
                            <form action="{{ url_for('delete_quiz_route', quiz_id=quiz['quiz_id']) }}" method="post" style="display: inline;">
                                <button type="submit" class="delete-quiz-button" onclick="return confirm('Are you sure you want to delete this quiz?');">Delete</button>
                            </form>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
        {% else %}
        <button style="text-align: center;" class="no-quiz-button">No quizzes available</button>
        {% endif %}

        <a href="{{ url_for('logout') }}">
            <button class="logout-button">Log Out</button>
        </a>
    </div>

    <script>
        // Audio control logic
        const audio = document.getElementById('background-music');
        const slider = document.getElementById('volume-slider');
        const icon = document.getElementById('audio-icon');
        const audioOnIcon = "{{ url_for('static', filename='audio-on.png') }}";
        const audioOffIcon = "{{ url_for('static', filename='audio-off.png') }}";

        function toggleMute() {
            if (audio.volume > 0) {
                slider.value = 0;
                audio.volume = 0;
                icon.src = audioOffIcon;
            } else {
                slider.value = 1;
                audio.volume = 1;
                icon.src = audioOnIcon;
            }
        }

        function adjustVolume() {
            audio.volume = slider.value;
            icon.src = audio.volume === 0 ? audioOffIcon : audioOnIcon;
        }

        audio.addEventListener('timeupdate', () => {
            localStorage.setItem('audioTime', audio.currentTime);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const savedTime = localStorage.getItem('audioTime');
            if (savedTime) audio.currentTime = parseFloat(savedTime);
            slider.value = audio.volume;
        });
    </script>
</body>
</html>
